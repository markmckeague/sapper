{"version":3,"file":"chunk-a03c60f1.js","sources":["../src/api/dev.ts"],"sourcesContent":["import * as path from 'path';\nimport * as fs from 'fs';\nimport * as http from 'http';\nimport * as child_process from 'child_process';\nimport * as ports from 'port-authority';\nimport mkdirp from 'mkdirp';\nimport rimraf from 'rimraf';\nimport format_messages from 'webpack-format-messages';\nimport { locations } from '../config';\nimport { EventEmitter } from 'events';\nimport { create_routes, create_main_manifests, create_compilers, create_serviceworker_manifest } from '../core';\nimport * as events from './interfaces';\n\nexport function dev(opts) {\n\treturn new Watcher(opts);\n}\n\nclass Watcher extends EventEmitter {\n\tdirs: {\n\t\tapp: string;\n\t\tdest: string;\n\t\troutes: string;\n\t\twebpack: string;\n\t}\n\tport: number;\n\tclosed: boolean;\n\n\tdev_server: DevServer;\n\tproc: child_process.ChildProcess;\n\tfilewatchers: Array<{ close: () => void }>;\n\tdeferreds: {\n\t\tclient: Deferred;\n\t\tserver: Deferred;\n\t};\n\n\tcrashed: boolean;\n\trestarting: boolean;\n\tcurrent_build: {\n\t\tchanged: Set<string>;\n\t\trebuilding: Set<string>;\n\t\tunique_warnings: Set<string>;\n\t\tunique_errors: Set<string>;\n\t}\n\n\tconstructor({\n\t\tapp = locations.app(),\n\t\tdest = locations.dest(),\n\t\troutes = locations.routes(),\n\t\twebpack = 'webpack',\n\t\tport = +process.env.PORT\n\t}: {\n\t\tapp: string,\n\t\tdest: string,\n\t\troutes: string,\n\t\twebpack: string,\n\t\tport: number\n\t}) {\n\t\tsuper();\n\n\t\tthis.dirs = { app, dest, routes, webpack };\n\t\tthis.port = port;\n\t\tthis.closed = false;\n\n\t\tthis.filewatchers = [];\n\n\t\tthis.current_build = {\n\t\t\tchanged: new Set(),\n\t\t\trebuilding: new Set(),\n\t\t\tunique_errors: new Set(),\n\t\t\tunique_warnings: new Set()\n\t\t};\n\n\t\t// remove this in a future version\n\t\tconst template = fs.readFileSync(path.join(app, 'template.html'), 'utf-8');\n\t\tif (template.indexOf('%sapper.base%') === -1) {\n\t\t\tconst error = new Error(`As of Sapper v0.10, your template.html file must include %sapper.base% in the <head>`);\n\t\t\terror.code = `missing-sapper-base`;\n\t\t\tthrow error;\n\t\t}\n\n\t\tprocess.env.NODE_ENV = 'development';\n\n\t\tprocess.on('exit', () => {\n\t\t\tthis.close();\n\t\t});\n\n\t\tthis.init();\n\t}\n\n\tasync init() {\n\t\tif (this.port) {\n\t\t\tif (!await ports.check(this.port)) {\n\t\t\t\tthis.emit('fatal', <events.FatalEvent>{\n\t\t\t\t\tmessage: `Port ${this.port} is unavailable`\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t} else {\n\t\t\tthis.port = await ports.find(3000);\n\t\t}\n\n\t\tconst { dest } = this.dirs;\n\t\trimraf.sync(dest);\n\t\tmkdirp.sync(dest);\n\n\t\tconst dev_port = await ports.find(10000);\n\t\tdev_port = this.port;\n\t\t\n\t\tconst routes = create_routes();\n\t\tcreate_main_manifests({ routes, dev_port });\n\n\t\tthis.dev_server = new DevServer(dev_port);\n\n\t\tthis.filewatchers.push(\n\t\t\twatch_files(locations.routes(), ['add', 'unlink'], () => {\n\t\t\t\tconst routes = create_routes();\n\t\t\t\tcreate_main_manifests({ routes, dev_port });\n\t\t\t}),\n\n\t\t\twatch_files(`${locations.app()}/template.html`, ['change'], () => {\n\t\t\t\tthis.dev_server.send({\n\t\t\t\t\taction: 'reload'\n\t\t\t\t});\n\t\t\t})\n\t\t);\n\n\t\tthis.deferreds = {\n\t\t\tserver: new Deferred(),\n\t\t\tclient: new Deferred()\n\t\t};\n\n\t\t// TODO watch the configs themselves?\n\t\tconst compilers = create_compilers({ webpack: this.dirs.webpack });\n\n\t\tlet log = '';\n\n\t\tconst emitFatal = () => {\n\t\t\tthis.emit('fatal', <events.FatalEvent>{\n\t\t\t\tmessage: `Server crashed`,\n\t\t\t\tlog\n\t\t\t});\n\n\t\t\tthis.crashed = true;\n\t\t\tthis.proc = null;\n\t\t};\n\n\t\tthis.watch(compilers.server, {\n\t\t\tname: 'server',\n\n\t\t\tinvalid: filename => {\n\t\t\t\tthis.restart(filename, 'server');\n\t\t\t\tthis.deferreds.server = new Deferred();\n\t\t\t},\n\n\t\t\tresult: info => {\n\t\t\t\tfs.writeFileSync(path.join(dest, 'server_info.json'), JSON.stringify(info, null, '  '));\n\n\t\t\t\tthis.deferreds.client.promise.then(() => {\n\t\t\t\t\tconst restart = () => {\n\t\t\t\t\t\tlog = '';\n\t\t\t\t\t\tthis.crashed = false;\n\n\t\t\t\t\t\tports.wait(this.port)\n\t\t\t\t\t\t\t.then((() => {\n\t\t\t\t\t\t\t\tthis.emit('ready', <events.ReadyEvent>{\n\t\t\t\t\t\t\t\t\tport: this.port,\n\t\t\t\t\t\t\t\t\tprocess: this.proc\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\tthis.deferreds.server.fulfil();\n\n\t\t\t\t\t\t\t\tthis.dev_server.send({\n\t\t\t\t\t\t\t\t\tstatus: 'completed'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t\t.catch(err => {\n\t\t\t\t\t\t\t\tif (this.crashed) return;\n\n\t\t\t\t\t\t\t\tthis.emit('fatal', <events.FatalEvent>{\n\t\t\t\t\t\t\t\t\tmessage: `Server is not listening on port ${this.port}`,\n\t\t\t\t\t\t\t\t\tlog\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t};\n\n\t\t\t\t\tif (this.proc) {\n\t\t\t\t\t\tthis.proc.removeListener('exit', emitFatal);\n\t\t\t\t\t\tthis.proc.kill();\n\t\t\t\t\t\tthis.proc.on('exit', restart);\n\t\t\t\t\t} else {\n\t\t\t\t\t\trestart();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.proc = child_process.fork(`${dest}/server.js`, [], {\n\t\t\t\t\t\tcwd: process.cwd(),\n\t\t\t\t\t\tenv: Object.assign({\n\t\t\t\t\t\t\tPORT: this.port\n\t\t\t\t\t\t}, process.env),\n\t\t\t\t\t\tstdio: ['ipc']\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.stdout.on('data', chunk => {\n\t\t\t\t\t\tlog += chunk;\n\t\t\t\t\t\tthis.emit('stdout', chunk);\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.stderr.on('data', chunk => {\n\t\t\t\t\t\tlog += chunk;\n\t\t\t\t\t\tthis.emit('stderr', chunk);\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.on('message', message => {\n\t\t\t\t\t\tif (message.__sapper__ && message.event === 'basepath') {\n\t\t\t\t\t\t\tthis.emit('basepath', {\n\t\t\t\t\t\t\t\tbasepath: message.basepath\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.on('exit', emitFatal);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tlet first = true;\n\n\t\tthis.watch(compilers.client, {\n\t\t\tname: 'client',\n\n\t\t\tinvalid: filename => {\n\t\t\t\tthis.restart(filename, 'client');\n\t\t\t\tthis.deferreds.client = new Deferred();\n\n\t\t\t\t// TODO we should delete old assets. due to a webpack bug\n\t\t\t\t// i don't even begin to comprehend, this is apparently\n\t\t\t\t// quite difficult\n\t\t\t},\n\n\t\t\tresult: info => {\n\t\t\t\tfs.writeFileSync(path.join(dest, 'client_info.json'), JSON.stringify(info));\n\t\t\t\tfs.writeFileSync(path.join(dest, 'client_assets.json'), JSON.stringify(info.assetsByChunkName, null, '  '));\n\t\t\t\tthis.deferreds.client.fulfil();\n\n\t\t\t\tconst client_files = info.assets.map((chunk: { name: string }) => `client/${chunk.name}`);\n\n\t\t\t\tcreate_serviceworker_manifest({\n\t\t\t\t\troutes: create_routes(),\n\t\t\t\t\tclient_files\n\t\t\t\t});\n\n\t\t\t\t// we need to wait a beat before watching the service\n\t\t\t\t// worker, because of some webpack nonsense\n\t\t\t\tsetTimeout(watch_serviceworker, 100);\n\t\t\t}\n\t\t});\n\n\t\tlet watch_serviceworker = compilers.serviceworker\n\t\t\t? () => {\n\t\t\t\twatch_serviceworker = noop;\n\n\t\t\t\tthis.watch(compilers.serviceworker, {\n\t\t\t\t\tname: 'service worker',\n\n\t\t\t\t\tresult: info => {\n\t\t\t\t\t\tfs.writeFileSync(path.join(dest, 'serviceworker_info.json'), JSON.stringify(info, null, '  '));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t: noop;\n\t}\n\n\tclose() {\n\t\tif (this.closed) return;\n\t\tthis.closed = true;\n\n\t\tthis.dev_server.close();\n\n\t\tif (this.proc) this.proc.kill();\n\t\tthis.filewatchers.forEach(watcher => {\n\t\t\twatcher.close();\n\t\t});\n\t}\n\n\trestart(filename: string, type: string) {\n\t\tif (this.restarting) {\n\t\t\tthis.current_build.changed.add(filename);\n\t\t\tthis.current_build.rebuilding.add(type);\n\t\t} else {\n\t\t\tthis.restarting = true;\n\n\t\t\tthis.current_build = {\n\t\t\t\tchanged: new Set([filename]),\n\t\t\t\trebuilding: new Set([type]),\n\t\t\t\tunique_warnings: new Set(),\n\t\t\t\tunique_errors: new Set()\n\t\t\t};\n\n\t\t\tprocess.nextTick(() => {\n\t\t\t\tthis.emit('invalid', <events.InvalidEvent>{\n\t\t\t\t\tchanged: Array.from(this.current_build.changed),\n\t\t\t\t\tinvalid: {\n\t\t\t\t\t\tserver: this.current_build.rebuilding.has('server'),\n\t\t\t\t\t\tclient: this.current_build.rebuilding.has('client'),\n\t\t\t\t\t\tserviceworker: this.current_build.rebuilding.has('serviceworker'),\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tthis.restarting = false;\n\t\t\t});\n\t\t}\n\t}\n\n\twatch(compiler: any, { name, invalid = noop, result }: {\n\t\tname: string,\n\t\tinvalid?: (filename: string) => void;\n\t\tresult: (stats: any) => void;\n\t}) {\n\t\tcompiler.hooks.invalid.tap('sapper', (filename: string) => {\n\t\t\tinvalid(filename);\n\t\t});\n\n\t\tcompiler.watch({}, (err: Error, stats: any) => {\n\t\t\tif (err) {\n\t\t\t\tthis.emit('error', <events.ErrorEvent>{\n\t\t\t\t\ttype: name,\n\t\t\t\t\tmessage: err.message\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tconst messages = format_messages(stats);\n\t\t\t\tconst info = stats.toJson();\n\n\t\t\t\tthis.emit('build', {\n\t\t\t\t\ttype: name,\n\n\t\t\t\t\tduration: info.time,\n\n\t\t\t\t\terrors: messages.errors.map((message: string) => {\n\t\t\t\t\t\tconst duplicate = this.current_build.unique_errors.has(message);\n\t\t\t\t\t\tthis.current_build.unique_errors.add(message);\n\n\t\t\t\t\t\treturn mungeWebpackError(message, duplicate);\n\t\t\t\t\t}),\n\n\t\t\t\t\twarnings: messages.warnings.map((message: string) => {\n\t\t\t\t\t\tconst duplicate = this.current_build.unique_warnings.has(message);\n\t\t\t\t\t\tthis.current_build.unique_warnings.add(message);\n\n\t\t\t\t\t\treturn mungeWebpackError(message, duplicate);\n\t\t\t\t\t}),\n\t\t\t\t});\n\n\t\t\t\tresult(info);\n\t\t\t}\n\t\t});\n\t}\n}\n\nconst locPattern = /\\((\\d+):(\\d+)\\)$/;\n\nfunction mungeWebpackError(message: string, duplicate: boolean) {\n\t// TODO this is all a bit rube goldberg...\n\tconst lines = message.split('\\n');\n\n\tconst file = lines.shift()\n\t\t.replace('\u001b[7m', '') // careful — there is a special character at the beginning of this string\n\t\t.replace('\u001b[27m', '')\n\t\t.replace('./', '');\n\n\tlet line = null;\n\tlet column = null;\n\n\tconst match = locPattern.exec(lines[0]);\n\tif (match) {\n\t\tlines[0] = lines[0].replace(locPattern, '');\n\t\tline = +match[1];\n\t\tcolumn = +match[2];\n\t}\n\n\treturn {\n\t\tfile,\n\t\tline,\n\t\tcolumn,\n\t\tmessage: lines.join('\\n'),\n\t\toriginalMessage: message,\n\t\tduplicate\n\t};\n}\n\nclass Deferred {\n\tpromise: Promise<any>;\n\tfulfil: (value?: any) => void;\n\treject: (error: Error) => void;\n\n\tconstructor() {\n\t\tthis.promise = new Promise((fulfil, reject) => {\n\t\t\tthis.fulfil = fulfil;\n\t\t\tthis.reject = reject;\n\t\t});\n\t}\n}\n\nconst INTERVAL = 10000;\n\nclass DevServer {\n\tclients: Set<http.ServerResponse>;\n\tinterval: NodeJS.Timer;\n\t_: http.Server;\n\n\tconstructor(port: number, interval = 10000) {\n\t\tthis.clients = new Set();\n\n\t\tthis._ = http.createServer((req, res) => {\n\t\t\tif (req.url !== '/__sapper__') return;\n\n\t\t\treq.socket.setKeepAlive(true);\n\t\t\tres.writeHead(200, {\n\t\t\t\t'Access-Control-Allow-Origin': '*',\n\t\t\t\t'Access-Control-Allow-Headers': 'Cache-Control',\n\t\t\t\t'Content-Type': 'text/event-stream;charset=utf-8',\n\t\t\t\t'Cache-Control': 'no-cache, no-transform',\n\t\t\t\t'Connection': 'keep-alive',\n\t\t\t\t// While behind nginx, event stream should not be buffered:\n\t\t\t\t// http://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffering\n\t\t\t\t'X-Accel-Buffering': 'no'\n\t\t\t});\n\n\t\t\tres.write('\\n');\n\n\t\t\tthis.clients.add(res);\n\t\t\treq.on('close', () => {\n\t\t\t\tthis.clients.delete(res);\n\t\t\t});\n\t\t});\n\n\t\tthis._.listen(port);\n\n\t\tthis.interval = setInterval(() => {\n\t\t\tthis.send(null);\n\t\t}, INTERVAL);\n\t}\n\n\tclose() {\n\t\tthis._.close();\n\t\tclearInterval(this.interval);\n\t}\n\n\tsend(data: any) {\n\t\tthis.clients.forEach(client => {\n\t\t\tclient.write(`data: ${JSON.stringify(data)}\\n\\n`);\n\t\t});\n\t}\n}\n\nfunction noop() {}\n\nfunction watch_files(pattern: string, events: string[], callback: () => void) {\n\tconst chokidar = require('chokidar');\n\n\tconst watcher = chokidar.watch(pattern, {\n\t\tpersistent: true,\n\t\tignoreInitial: true,\n\t\tdisableGlobbing: true\n\t});\n\n\tevents.forEach(event => {\n\t\twatcher.on(event, callback);\n\t});\n\n\treturn {\n\t\tclose: () => watcher.close()\n\t};\n}\n"],"names":["tslib_1.__extends","fs.readFileSync","path.join","ports.check","ports.find","create_routes","create_main_manifests","locations","create_compilers","fs.writeFileSync","ports.wait","child_process.fork","create_serviceworker_manifest","EventEmitter","http.createServer","events"],"mappings":"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"}