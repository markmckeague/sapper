{"version":3,"file":"middleware.ts.js","sources":["../src/middleware/mime.ts","../src/middleware.ts"],"sourcesContent":["import mime_raw from './mime-types.md';\n\nconst map: Map<string, string> = new Map();\n\nmime_raw.split('\\n').forEach((row: string) => {\n\tconst match = /(.+?)\\t+(.+)/.exec(row);\n\tif (!match) return;\n\n\tconst type = match[1];\n\tconst extensions = match[2].split(' ');\n\n\textensions.forEach(ext => {\n\t\tmap.set(ext, type);\n\t});\n});\n\nexport function lookup(file: string) {\n\tconst match = /\\.([^\\.]+)$/.exec(file);\n\treturn match && map.get(match[1]);\n}","import * as fs from 'fs';\nimport * as path from 'path';\nimport { URL } from 'url';\nimport { ClientRequest, ServerResponse } from 'http';\nimport cookie from 'cookie';\nimport devalue from 'devalue';\nimport fetch from 'node-fetch';\nimport { lookup } from './middleware/mime';\nimport { locations, dev } from './config';\nimport sourceMapSupport from 'source-map-support';\n\nsourceMapSupport.install();\n\ntype RouteObject = {\n\tid: string;\n\ttype: 'page' | 'route';\n\tpattern: RegExp;\n\tparams: (match: RegExpMatchArray) => Record<string, string>;\n\tmodule: Component;\n\terror?: string;\n}\n\ntype Handler = (req: Req, res: ServerResponse, next: () => void) => void;\n\ntype Store = {\n\tget: () => any\n};\n\ninterface Req extends ClientRequest {\n\turl: string;\n\tbaseUrl: string;\n\toriginalUrl: string;\n\tmethod: string;\n\tpath: string;\n\tparams: Record<string, string>;\n\theaders: Record<string, string>;\n}\n\ninterface Component {\n\trender: (data: any, opts: { store: Store }) => {\n\t\thead: string;\n\t\tcss: { code: string, map: any };\n\t\thtml: string\n\t},\n\tpreload: (data: any) => any | Promise<any>\n}\n\nexport default function middleware({ App, routes, store }: {\n\tApp: Component,\n\troutes: RouteObject[],\n\tstore: (req: Req) => Store\n}) {\n\tif (!App) {\n\t\tthrow new Error(`As of 0.12, you must supply an App component to Sapper â€” see https://sapper.svelte.technology/guide#0-11-to-0-12 for more information`);\n\t}\n\n\tconst output = locations.dest();\n\n\tlet emitted_basepath = false;\n\n\tconst middleware = compose_handlers([\n\t\t(req: Req, res: ServerResponse, next: () => void) => {\n\t\t\tif (req.baseUrl === undefined) {\n\t\t\t\tlet { originalUrl } = req;\n\t\t\t\tif (req.url === '/' && originalUrl[originalUrl.length - 1] !== '/') {\n\t\t\t\t\toriginalUrl += '/';\n\t\t\t\t}\n\n\t\t\t\treq.baseUrl = originalUrl\n\t\t\t\t\t? originalUrl.slice(0, -req.url.length)\n\t\t\t\t\t: '';\n\t\t\t}\n\n\t\t\tif (!emitted_basepath && process.send) {\n\t\t\t\tprocess.send({\n\t\t\t\t\t__sapper__: true,\n\t\t\t\t\tevent: 'basepath',\n\t\t\t\t\tbasepath: req.baseUrl\n\t\t\t\t});\n\n\t\t\t\temitted_basepath = true;\n\t\t\t}\n\n\t\t\tif (req.path === undefined) {\n\t\t\t\treq.path = req.url.replace(/\\?.*/, '');\n\t\t\t}\n\n\t\t\tnext();\n\t\t},\n\n\t\tfs.existsSync(path.join(output, 'index.html')) && serve({\n\t\t\tpathname: '/index.html',\n\t\t\tcache_control: 'max-age=600'\n\t\t}),\n\n\t\tfs.existsSync(path.join(output, 'service-worker.js')) && serve({\n\t\t\tpathname: '/service-worker.js',\n\t\t\tcache_control: 'max-age=600'\n\t\t}),\n\n\t\tfs.existsSync(path.join(output, 'service-worker.js.map')) && serve({\n\t\t\tpathname: '/service-worker.js.map',\n\t\t\tcache_control: 'max-age=600'\n\t\t}),\n\n\t\tserve({\n\t\t\tprefix: '/client/',\n\t\t\tcache_control: 'max-age=31536000'\n\t\t}),\n\n\t\tget_server_route_handler(routes.server_routes),\n\t\tget_page_handler(App, routes, store)\n\t].filter(Boolean));\n\n\treturn middleware;\n}\n\nfunction serve({ prefix, pathname, cache_control }: {\n\tprefix?: string,\n\tpathname?: string,\n\tcache_control: string\n}) {\n\tconst filter = pathname\n\t\t? (req: Req) => req.path === pathname\n\t\t: (req: Req) => req.path.startsWith(prefix);\n\n\tconst output = locations.dest();\n\n\tconst cache: Map<string, Buffer> = new Map();\n\n\tconst read = dev()\n\t\t? (file: string) => fs.readFileSync(path.resolve(output, file))\n\t\t: (file: string) => (cache.has(file) ? cache : cache.set(file, fs.readFileSync(path.resolve(output, file)))).get(file)\n\n\treturn (req: Req, res: ServerResponse, next: () => void) => {\n\t\tif (filter(req)) {\n\t\t\tconst type = lookup(req.path);\n\n\t\t\ttry {\n\t\t\t\tconst data = read(req.path.slice(1));\n\n\t\t\t\tres.setHeader('Content-Type', type);\n\t\t\t\tres.setHeader('Cache-Control', cache_control);\n\t\t\t\tres.end(data);\n\t\t\t} catch (err) {\n\t\t\t\tres.statusCode = 404;\n\t\t\t\tres.end('not found');\n\t\t\t}\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\t};\n}\n\nfunction get_server_route_handler(routes: RouteObject[]) {\n\tfunction handle_route(route, req, res, next) {\n\t\treq.params = route.params(route.pattern.exec(req.path));\n\n\t\tconst method = req.method.toLowerCase();\n\t\t// 'delete' cannot be exported from a module because it is a keyword,\n\t\t// so check for 'del' instead\n\t\tconst method_export = method === 'delete' ? 'del' : method;\n\t\tconst handle_method = route.handlers[method_export];\n\t\tif (handle_method) {\n\t\t\tif (process.env.SAPPER_EXPORT) {\n\t\t\t\tconst { write, end, setHeader } = res;\n\t\t\t\tconst chunks: any[] = [];\n\t\t\t\tconst headers: Record<string, string> = {};\n\n\t\t\t\t// intercept data so that it can be exported\n\t\t\t\tres.write = function(chunk: any) {\n\t\t\t\t\tchunks.push(new Buffer(chunk));\n\t\t\t\t\twrite.apply(res, arguments);\n\t\t\t\t};\n\n\t\t\t\tres.setHeader = function(name: string, value: string) {\n\t\t\t\t\theaders[name.toLowerCase()] = value;\n\t\t\t\t\tsetHeader.apply(res, arguments);\n\t\t\t\t};\n\n\t\t\t\tres.end = function(chunk?: any) {\n\t\t\t\t\tif (chunk) chunks.push(new Buffer(chunk));\n\t\t\t\t\tend.apply(res, arguments);\n\n\t\t\t\t\tprocess.send({\n\t\t\t\t\t\t__sapper__: true,\n\t\t\t\t\t\tevent: 'file',\n\t\t\t\t\t\turl: req.url,\n\t\t\t\t\t\tmethod: req.method,\n\t\t\t\t\t\tstatus: res.statusCode,\n\t\t\t\t\t\ttype: headers['content-type'],\n\t\t\t\t\t\tbody: Buffer.concat(chunks).toString()\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst handle_next = (err?: Error) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err.stack);\n\t\t\t\t\tres.statusCode = 500;\n\t\t\t\t\tres.end(err.message);\n\t\t\t\t} else {\n\t\t\t\t\tprocess.nextTick(next);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\thandle_method(req, res, handle_next);\n\t\t\t} catch (err) {\n\t\t\t\thandle_next(err);\n\t\t\t}\n\t\t} else {\n\t\t\t// no matching handler for method\n\t\t\tprocess.nextTick(next);\n\t\t}\n\t}\n\n\treturn function find_route(req: Req, res: ServerResponse, next) {\n\t\tfor (const route of routes) {\n\t\t\tif (route.pattern.test(req.path)) {\n\t\t\t\thandle_route(route, req, res, next);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tnext();\n\t};\n}\n\nfunction get_page_handler(App: Component, routes: RouteObject[], store_getter: (req: Req) => Store) {\n\tconst output = locations.dest();\n\n\tconst get_chunks = dev()\n\t\t? () => JSON.parse(fs.readFileSync(path.join(output, 'client_assets.json'), 'utf-8'))\n\t\t: (assets => () => assets)(JSON.parse(fs.readFileSync(path.join(output, 'client_assets.json'), 'utf-8')));\n\n\tconst template = dev()\n\t\t? () => fs.readFileSync(`${locations.app()}/template.html`, 'utf-8')\n\t\t: (str => () => str)(fs.readFileSync(`${locations.dest()}/template.html`, 'utf-8'));\n\n\tconst { server_routes, pages } = routes;\n\tconst error_route = routes.error;\n\n\tfunction handle_route(route: RouteObject, req: Req, res: ServerResponse, status = 200, error: Error | string = null) {\n\t\treq.params = error\n\t\t\t? {}\n\t\t\t: route.params(route.pattern.exec(req.path));\n\n\t\tconst chunks: Record<string, string> = get_chunks();\n\n\t\tres.setHeader('Content-Type', 'text/html');\n\n\t\t// preload main.js and current route\n\t\t// TODO detect other stuff we can preload? images, CSS, fonts?\n\t\tconst link = []\n\t\t\t.concat(chunks.main, chunks[route.id] || chunks._error) // TODO this is gross\n\t\t\t.filter(file => !file.match(/\\.map$/))\n\t\t\t.map(file => `<${req.baseUrl}/client/${file}>;rel=\"preload\";as=\"script\"`)\n\t\t\t.join(', ');\n\n\t\tres.setHeader('Link', link);\n\n\t\tconst store = store_getter ? store_getter(req) : null;\n\t\tconst props = { params: req.params, query: req.query, path: req.path };\n\n\t\tif (route.error) {\n\t\t\tprops.error = error instanceof Error ? error : { message: error };\n\t\t\tprops.status = status;\n\t\t}\n\n\t\tlet redirect: { statusCode: number, location: string };\n\t\tlet preload_error: { statusCode: number, message: Error | string };\n\n\t\tPromise.resolve(\n\t\t\troute.handler.preload ? route.handler.preload.call({\n\t\t\t\tredirect: (statusCode: number, location: string) => {\n\t\t\t\t\tredirect = { statusCode, location };\n\t\t\t\t},\n\t\t\t\terror: (statusCode: number, message: Error | string) => {\n\t\t\t\t\tpreload_error = { statusCode, message };\n\t\t\t\t},\n\t\t\t\tfetch: (url: string, opts?: any) => {\n\t\t\t\t\tconst parsed = new URL(url, `http://127.0.0.1:${process.env.PORT}${req.baseUrl ? req.baseUrl + '/'  :''}`);\n\n\t\t\t\t\tif (opts) {\n\t\t\t\t\t\topts = Object.assign({}, opts);\n\n\t\t\t\t\t\tconst include_cookies = (\n\t\t\t\t\t\t\topts.credentials === 'include' ||\n\t\t\t\t\t\t\topts.credentials === 'same-origin' && parsed.origin === `http://127.0.0.1:${process.env.PORT}`\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (include_cookies) {\n\t\t\t\t\t\t\tconst cookies: Record<string, string> = {};\n\t\t\t\t\t\t\tif (!opts.headers) opts.headers = {};\n\n\t\t\t\t\t\t\tconst str = []\n\t\t\t\t\t\t\t\t.concat(\n\t\t\t\t\t\t\t\t\tcookie.parse(req.headers.cookie || ''),\n\t\t\t\t\t\t\t\t\tcookie.parse(opts.headers.cookie || ''),\n\t\t\t\t\t\t\t\t\tcookie.parse(res.getHeader('Set-Cookie') || '')\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.map(cookie => {\n\t\t\t\t\t\t\t\t\treturn Object.keys(cookie)\n\t\t\t\t\t\t\t\t\t\t.map(name => `${name}=${encodeURIComponent(cookie[name])}`)\n\t\t\t\t\t\t\t\t\t\t.join('; ');\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.filter(Boolean)\n\t\t\t\t\t\t\t\t.join(', ');\n\n\t\t\t\t\t\t\topts.headers.cookie = str;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn fetch(parsed.href, opts);\n\t\t\t\t},\n\t\t\tstore\n\t\t\t}, req) : {}\n\t\t).catch(err => {\n\t\t\tpreload_error = { statusCode: 500, message: err };\n\t\t}).then(preloaded => {\n\t\t\tif (redirect) {\n\t\t\t\tres.statusCode = redirect.statusCode;\n\t\t\t\tres.setHeader('Location', `${req.baseUrl}/${redirect.location}`);\n\t\t\t\tres.end();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (preload_error) {\n\t\t\t\thandle_route(error_route, req, res, preload_error.statusCode, preload_error.message);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst serialized = {\n\t\t\t\tpreloaded: route.handler.preload && try_serialize(preloaded),\n\t\t\t\tstore: store && try_serialize(store.get())\n\t\t\t};\n\t\t\tObject.assign(props, preloaded);\n\n\t\t\tconst { html, head, css } = App.render({ Page: route.handler, props }, {\n\t\t\t\tstore\n\t\t\t});\n\n\t\t\tlet scripts = []\n\t\t\t\t.concat(chunks.main) // chunks main might be an array. it might not! thanks, webpack\n\t\t\t\t.filter(file => !file.match(/\\.map$/))\n\t\t\t\t.map(file => `<script src='${req.baseUrl}/client/${file}'></script>`)\n\t\t\t\t.join('');\n\n\t\t\tlet inline_script = `__SAPPER__={${[\n\t\t\t\t`baseUrl: \"${req.baseUrl}\"`,\n\t\t\t\tserialized.preloaded && `preloaded: ${serialized.preloaded}`,\n\t\t\t\tserialized.store && `store: ${serialized.store}`\n\t\t\t].filter(Boolean).join(',')}};`;\n\n\t\t\tconst has_service_worker = fs.existsSync(path.join(locations.dest(), 'service-worker.js'));\n\t\t\tif (has_service_worker) {\n\t\t\t\tinline_script += `if ('serviceWorker' in navigator) navigator.serviceWorker.register('${req.baseUrl}/service-worker.js');`;\n\t\t\t}\n\n\t\t\tconst page = template()\n\t\t\t\t.replace('%sapper.base%', () => `<base href=\"${req.baseUrl}/\">`)\n\t\t\t\t.replace('%sapper.scripts%', () => `<script>${inline_script}</script>${scripts}`)\n\t\t\t\t.replace('%sapper.html%', () => html)\n\t\t\t\t.replace('%sapper.head%', () => `<noscript id='sapper-head-start'></noscript>${head}<noscript id='sapper-head-end'></noscript>`)\n\t\t\t\t.replace('%sapper.styles%', () => (css && css.code ? `<style>${css.code}</style>` : ''));\n\n\t\t\tres.statusCode = status;\n\t\t\tres.end(page);\n\n\t\t\tif (process.send) {\n\t\t\t\tprocess.send({\n\t\t\t\t\t__sapper__: true,\n\t\t\t\t\tevent: 'file',\n\t\t\t\t\turl: req.url,\n\t\t\t\t\tmethod: req.method,\n\t\t\t\t\tstatus: 200,\n\t\t\t\t\ttype: 'text/html',\n\t\t\t\t\tbody: page\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\treturn function find_route(req: Req, res: ServerResponse) {\n\t\tif (!server_routes.some(route => route.pattern.test(req.path))) {\n\t\t\tfor (const page of pages) {\n\t\t\t\tif (page.pattern.test(req.path)) {\n\t\t\t\t\thandle_route(page, req, res);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\thandle_route(error_route, req, res, 404, 'Not found');\n\t};\n}\n\nfunction compose_handlers(handlers: Handler[]) {\n\treturn (req: Req, res: ServerResponse, next: () => void) => {\n\t\tlet i = 0;\n\t\tfunction go() {\n\t\t\tconst handler = handlers[i];\n\n\t\t\tif (handler) {\n\t\t\t\thandler(req, res, () => {\n\t\t\t\t\ti += 1;\n\t\t\t\t\tgo();\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tnext();\n\t\t\t}\n\t\t}\n\n\t\tgo();\n\t};\n}\n\nfunction try_serialize(data: any) {\n\ttry {\n\t\treturn devalue(data);\n\t} catch (err) {\n\t\treturn null;\n\t}\n}\n"],"names":["locations","fs.existsSync","path.join","dev","fs.readFileSync","path.resolve","url","URL","cookie"],"mappings":"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"}